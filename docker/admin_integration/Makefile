# SeaweedFS Admin Integration Test Makefile
# Tests the admin server and worker functionality using official weed commands

.PHONY: help build build-and-restart start stop restart logs clean status test admin-ui worker-logs master-logs admin-logs
.DEFAULT_GOAL := help

COMPOSE_FILE := docker-compose-ec-test.yml
PROJECT_NAME := admin_integration

build: ## Build SeaweedFS with latest changes and create Docker image
	@echo "ğŸ”¨ Building SeaweedFS with latest changes..."
	@echo "1ï¸âƒ£ Generating admin templates..."
	@cd ../../ && make admin-generate
	@echo "2ï¸âƒ£ Building Docker image with latest changes..."
	@cd ../ && make build
	@echo "3ï¸âƒ£ Copying binary for local docker-compose..."
	@cp ../weed ./weed-local
	@echo "âœ… Build complete! Updated image: chrislusf/seaweedfs:local"
	@echo "ğŸ’¡ Run 'make restart' to apply changes to running services"

build-and-restart: build ## Build with latest changes and restart services
	@echo "ğŸ”„ Restarting services to apply changes..."
	@docker-compose -f $(COMPOSE_FILE) restart admin
	@echo "âœ… Services restarted with latest changes!"
	@echo "ğŸŒ Admin UI: http://localhost:23646/"

help: ## Show this help message
	@echo "SeaweedFS Admin Integration Test"
	@echo "================================"
	@echo "Tests admin server task distribution to workers using official weed commands"
	@echo ""
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-15s %s\n", $$1, $$2}'

start: ## Start the complete SeaweedFS cluster with admin and workers
	@echo "ğŸš€ Starting SeaweedFS cluster with admin and workers..."
	@docker-compose -f $(COMPOSE_FILE) up -d
	@echo "âœ… Cluster started!"
	@echo ""
	@echo "ğŸ“Š Access points:"
	@echo "  â€¢ Admin UI:      http://localhost:23646/"
	@echo "  â€¢ Master UI:     http://localhost:9333/"
	@echo "  â€¢ Filer:         http://localhost:8888/"
	@echo ""
	@echo "ğŸ“ˆ Services starting up..."
	@echo "  â€¢ Master server:  âœ“"
	@echo "  â€¢ Volume servers: Starting (6 servers)..."
	@echo "  â€¢ Filer:          Starting..."
	@echo "  â€¢ Admin server:   Starting..."
	@echo "  â€¢ Workers:        Starting (3 workers)..."
	@echo ""
	@echo "â³ Use 'make status' to check startup progress"
	@echo "ğŸ’¡ Use 'make logs' to watch the startup process"

start-staged: ## Start services in proper order with delays
	@echo "ğŸš€ Starting SeaweedFS cluster in stages..."
	@echo ""
	@echo "Stage 1: Starting Master server..."
	@docker-compose -f $(COMPOSE_FILE) up -d master
	@sleep 10
	@echo ""
	@echo "Stage 2: Starting Volume servers..."
	@docker-compose -f $(COMPOSE_FILE) up -d volume1 volume2 volume3 volume4 volume5 volume6
	@sleep 15
	@echo ""
	@echo "Stage 3: Starting Filer..."
	@docker-compose -f $(COMPOSE_FILE) up -d filer
	@sleep 10
	@echo ""
	@echo "Stage 4: Starting Admin server..."
	@docker-compose -f $(COMPOSE_FILE) up -d admin
	@sleep 15
	@echo ""
	@echo "Stage 5: Starting Workers..."
	@docker-compose -f $(COMPOSE_FILE) up -d worker1 worker2 worker3
	@sleep 10
	@echo ""
	@echo "Stage 6: Starting Load generator and Monitor..."
	@docker-compose -f $(COMPOSE_FILE) up -d load_generator monitor
	@echo ""
	@echo "âœ… All services started!"
	@echo ""
	@echo "ğŸ“Š Access points:"
	@echo "  â€¢ Admin UI:      http://localhost:23646/"
	@echo "  â€¢ Master UI:     http://localhost:9333/"
	@echo "  â€¢ Filer:         http://localhost:8888/"
	@echo ""
	@echo "â³ Services are initializing... Use 'make status' to check progress"

stop: ## Stop all services
	@echo "ğŸ›‘ Stopping SeaweedFS cluster..."
	@docker-compose -f $(COMPOSE_FILE) down
	@echo "âœ… Cluster stopped"

restart: stop start ## Restart the entire cluster

clean: ## Stop and remove all containers, networks, and volumes
	@echo "ğŸ§¹ Cleaning up SeaweedFS test environment..."
	@docker-compose -f $(COMPOSE_FILE) down -v --remove-orphans
	@docker system prune -f
	@rm -rf data/
	@echo "âœ… Environment cleaned"

status: ## Check the status of all services
	@echo "ğŸ“Š SeaweedFS Cluster Status"
	@echo "=========================="
	@docker-compose -f $(COMPOSE_FILE) ps
	@echo ""
	@echo "ğŸ“‹ Service Health:"
	@echo "Master:"
	@curl -s http://localhost:9333/cluster/status | jq '.IsLeader' 2>/dev/null || echo "  âŒ Master not ready"
	@echo "Admin:"
	@curl -s http://localhost:23646/ | grep -q "Admin" && echo "  âœ… Admin ready" || echo "  âŒ Admin not ready"

logs: ## Show logs from all services
	@echo "ğŸ“œ Following logs from all services..."
	@echo "ğŸ’¡ Press Ctrl+C to stop following logs"
	@docker-compose -f $(COMPOSE_FILE) logs -f

admin-logs: ## Show logs from admin server only
	@echo "ğŸ“œ Admin server logs:"
	@docker-compose -f $(COMPOSE_FILE) logs -f admin

worker-logs: ## Show logs from all workers
	@echo "ğŸ“œ Worker logs:"
	@docker-compose -f $(COMPOSE_FILE) logs -f worker1 worker2 worker3

master-logs: ## Show logs from master server
	@echo "ğŸ“œ Master server logs:"
	@docker-compose -f $(COMPOSE_FILE) logs -f master

admin-ui: ## Open admin UI in browser (macOS)
	@echo "ğŸŒ Opening admin UI in browser..."
	@open http://localhost:23646/ || echo "ğŸ’¡ Manually open: http://localhost:23646/"

test: ## Run integration test to verify task assignment and completion
	@echo "ğŸ§ª Running Admin-Worker Integration Test"
	@echo "========================================"
	@echo ""
	@echo "1ï¸âƒ£ Checking cluster health..."
	@sleep 5
	@curl -s http://localhost:9333/cluster/status | jq '.IsLeader' > /dev/null && echo "âœ… Master healthy" || echo "âŒ Master not ready"
	@curl -s http://localhost:23646/ | grep -q "Admin" && echo "âœ… Admin healthy" || echo "âŒ Admin not ready"
	@echo ""
	@echo "2ï¸âƒ£ Checking worker registration..."
	@sleep 10
	@echo "ğŸ’¡ Check admin UI for connected workers: http://localhost:23646/"
	@echo ""
	@echo "3ï¸âƒ£ Generating load to trigger EC tasks..."
	@echo "ğŸ“ Creating test files to fill volumes..."
	@echo "Creating large files with random data to trigger EC (targeting ~60MB total to exceed 50MB limit)..."
	@for i in {1..12}; do \
		echo "Creating 5MB random file $$i..."; \
		docker run --rm --network admin_integration_seaweed_net -v /tmp:/tmp --entrypoint sh chrislusf/seaweedfs:local -c "dd if=/dev/urandom of=/tmp/largefile$$i.dat bs=1M count=5 2>/dev/null && weed upload -master=master:9333 /tmp/largefile$$i.dat && rm /tmp/largefile$$i.dat"; \
		sleep 3; \
	done
	@echo ""
	@echo "4ï¸âƒ£ Waiting for volumes to process large files and reach 50MB limit..."
	@echo "This may take a few minutes as we're uploading 60MB of data..."
	@sleep 60
	@echo ""
	@echo "5ï¸âƒ£ Checking for EC task creation and assignment..."
	@echo "ğŸ’¡ Monitor the admin UI to see:"
	@echo "   â€¢ Tasks being created for volumes needing EC"
	@echo "   â€¢ Workers picking up tasks"
	@echo "   â€¢ Task progress (pending â†’ running â†’ completed)"
	@echo "   â€¢ EC shards being distributed"
	@echo ""
	@echo "âœ… Integration test setup complete!"
	@echo "ğŸ“Š Monitor progress at: http://localhost:23646/"

quick-test: ## Quick verification that core services are running
	@echo "âš¡ Quick Health Check"
	@echo "===================="
	@echo "Master:  $$(curl -s http://localhost:9333/cluster/status | jq -r '.IsLeader // "not ready"')"
	@echo "Admin:   $$(curl -s http://localhost:23646/ | grep -q "Admin" && echo "ready" || echo "not ready")"
	@echo "Workers: $$(docker-compose -f $(COMPOSE_FILE) ps worker1 worker2 worker3 | grep -c Up) running"

validate: ## Validate integration test configuration
	@echo "ğŸ” Validating Integration Test Configuration"
	@echo "==========================================="
	@chmod +x test-integration.sh
	@./test-integration.sh

demo: start ## Start cluster and run demonstration
	@echo "ğŸ­ SeaweedFS Admin-Worker Demo"
	@echo "============================="
	@echo ""
	@echo "â³ Waiting for services to start..."
	@sleep 45
	@echo ""
	@echo "ğŸ¯ Demo Overview:"
	@echo "  â€¢ 1 Master server (coordinates cluster)"
	@echo "  â€¢ 6 Volume servers (50MB volume limit)"
	@echo "  â€¢ 1 Admin server (task management)"
	@echo "  â€¢ 3 Workers (execute EC tasks)"
	@echo "  â€¢ Load generator (creates files continuously)"
	@echo ""
	@echo "ğŸ“Š Watch the process:"
	@echo "  1. Visit: http://localhost:23646/"
	@echo "  2. Observe workers connecting"
	@echo "  3. Watch tasks being created and assigned"
	@echo "  4. See tasks progress from pending â†’ completed"
	@echo ""
	@echo "ğŸ”„ The demo will:"
	@echo "  â€¢ Fill volumes to 50MB limit"
	@echo "  â€¢ Admin detects volumes needing EC"
	@echo "  â€¢ Workers receive and execute EC tasks"
	@echo "  â€¢ Tasks complete with shard distribution"
	@echo ""
	@echo "ğŸ’¡ Use 'make worker-logs' to see worker activity"
	@echo "ğŸ’¡ Use 'make admin-logs' to see admin task management" 