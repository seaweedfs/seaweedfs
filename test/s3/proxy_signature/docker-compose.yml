services:
  seaweedfs:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      /usr/bin/weed server
      -master -volume -filer -s3
      -s3.config=/etc/seaweedfs/s3.json
      -s3.externalUrl=http://localhost:9000
      -volume.max=0
      -ip=seaweedfs
    volumes:
      - ./s3.json:/etc/seaweedfs/s3.json:ro
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8333/status"]
      interval: 3s
      timeout: 2s
      retries: 20
      start_period: 5s

  nginx:
    image: nginx:alpine
    ports:
      - "9000:9000"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      seaweedfs:
        condition: service_healthy
